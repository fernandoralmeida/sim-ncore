@page
@model Sim.UI.Web.Areas.SimBI.Pages.Empresas.CnaesModel

@{
     Layout = "_Layout.cshtml";
    ViewData["Title"] = "Power BI";
    ViewData["BIActivePage"] = Sim.UI.Web.Areas.SimBI.Pages.Empresas.EmpNavPages.Cnae;
}

<partial name="_NavBar" model="@Model.MunicipioSelecionado" />
<partial name="_StatusMessage" model="Model.StatusMessage" />

<div class="row">
    <ul class="collapsible white borderless rounded-default">
            @foreach (var emp in Model.ListCnaes)
            {
                @foreach (var s in emp.ListaSecao)
                {
                    <li>
                        <div class="collapsible-header">@s.Secao.Key<span class="new badge blue" data-badge-caption="">@s.Secao.Value</span></div>
                        <div class="collapsible-body pdn-10">
                            <div class="mgn-10 right-align"><a class="modal-trigger" href="#viewmodal" data-cnaei="@s.FaixaInicial" data-cnaef="@s.FaixaFinal" data-munic="@Model.MunicipioSelecionado">Listar Classe</a></div>
                            <ul class="collapsible z-depth-0 mgn-10">
                                @foreach (var d in s.ListaClasse)
                                {

                                    string cnaei = d.Classe.Key.Remove(2, d.Classe.Key.Length - 2) + "00000";
                                    string cnaef = d.Classe.Key.Remove(2, d.Classe.Key.Length - 2) + "99999";

                                    <li>
                                        <div class="collapsible-header">@d.Classe.Key<span class="new badge blue-grey darken-1" data-badge-caption="">@d.Classe.Value</span></div>
                                        <div class="collapsible-body">
                                            <div class="mgn-10 right-align"><a class="modal-trigger" href="#viewmodal" data-cnaei="@cnaei" data-munic="@Model.MunicipioSelecionado" data-cnaef="@cnaef">Listar Subclasse</a></div>
                                            <ul class="collection z-depth-1">
                                                @foreach (var sc in d.ListaSubClasse)
                                                {
                                                    string[] cnae = sc.Key.Split(" - ");
                                                    var codigo = cnae[0];

                                                    <li class="collection-item"><a class="modal-trigger" href="#viewmodal" data-cnaei="@codigo" data-cnaef="@codigo" data-munic="@Model.MunicipioSelecionado"  title="Ver empresas"><span class="new badge" data-badge-caption="">@sc.Value</span></a>@sc.Key</li>
                                                }
                                            </ul>
                                        </div>
                                    </li>
                                }
                            </ul>
                        </div>
                    </li>
                }
            }        
    </ul>
</div>
<div class="row alpha-text-4 font-size-12 mgn-t-10">
    Informações extraidas da base de dados da RFB em 12-07-2022
</div>
<!-- Modal Structure -->
<div id="viewmodal" class="modal modal-fixed-footer">
    <div class="modal-content">
        <div class="loadingpage"></div>
        <table class="striped" style="font-size:12px;">
        <thead>
          <tr>
              <th>#</th>
              <th>CNPJ</th>
              <th>Razão Social</th>
              <th>Tel</th>
              <th>Email</th>
              <th>Cnae</th>
          </tr>
        </thead>
        <tbody class="showcollection"></tbody>
      </table>
    </div>
    <div class="modal-footer">
        <a id="btn-export" href="" class="btn waves-effect waves-light green" title="Exportar"><i class="material-icons">description file_download</i></a>
        <a href="#!" class="modal-close btn waves-effect">Fechar</a>
    </div>
</div>

@section scripts{
    <script>        
        $(function () {
            $(".btnsubmit").click(function () {
                $('#formbiemp').submit();
                $(this).prop('disabled', true);                
            });
            $(".modal-trigger").click(function () {
                var param0 = $(this).data('cnaei');
                var param1 = $(this).data('cnaef');
                var param2 = $(this).data('munic');;
                var cont = 0;
                var a = document.getElementById('btn-export');
                a.href = `/SimBI/Empresas/Export?ci=${param0}&cf=${param1}&m=${param2}&a=Ativa`;

                $(".showcollection").empty();
                $(".loadingpage").append(`<div class="progress"><div class="indeterminate"></div></div>`);
                $.getJSON(`/SimBI/Empresas/Cnaes?ci=${param0}&cf=${param1}&m=${param2}&a=Ativa&handler=Preview`, function (data) {
                    $(".loadingpage").empty();
                    $.each(data, function (i, item) {

                        var v1 = item.item1;
                        var vm = v1.slice(0,2) + "." + v1.slice(2,5) + "." + v1.slice(5,8) + "/" + v1.slice(8,12) + "-" + v1.slice(12,14);
                        var v2 = item.item2;
                        var v3 = item.item3 != null? item.item3: "";
                        var v4 = item.item4 != null? item.item4: "";
                        var v5 = item.item5;
                        
                        cont++;

                        $(".showcollection").append(                            
                            `<tr>
                            <td>${cont}</td>
                            <td><a href="/Censo/Empresas/Detalhe?id=${v1}" target="_blank">${vm}</a></td>
                            <td>${v2}</td>
                            <td>${v3}</td>
                            <td>${v4}</td>
                            <td>${v5}</td>
                            </tr>`                        
                        );
                    });
                });
            });
        });
    </script>
}