@using Microsoft.AspNetCore.Identity
@using Sim.Identity.Entity
@using Sim.Application.Interfaces

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject IAppServiceStatusAtendimento MeuStatus

@{
    var _lstatus = await MeuStatus.ListUserAsync(User.Identity.Name);
    var _status = _lstatus.FirstOrDefault().Online;
    var _idstatus = _lstatus.FirstOrDefault().Id;
}
<input id="meustatusonline" type="text" value="@_idstatus" hidden/>

<div class="navbar-fixed">
    <nav class="navbar z-depth-0">
        <div class="nav-wrapper">
            <a href="#" data-target="sidenav-left" class="sidenav-trigger "><i class="material-icons">menu</i></a>
            <a class="navbar-page-name ">@ViewData["Title"]</a>
            <ul class="right">                
                    @if(SignInManager.IsSignedIn(User))
                    {
                        var DisplayName = UserManager.Users.FirstOrDefault(m => m.UserName == User.Identity.Name).Name;
                        var DisplayLastName = UserManager.Users.FirstOrDefault(m => m.UserName == User.Identity.Name).LastName;
                        
                        var fn = DisplayName.FirstOrDefault();
                        var ln = DisplayLastName.FirstOrDefault();

                        var account_color = "";

                        @if (!_status)
                        { account_color = "alpha-w-text-8"; }
                        else
                        { account_color = "alpha-text-7"; }

                        <li class="dropdown-trigger @LayoutNavPages.LoginNavClass(ViewContext) mgn-r-10" data-target="dropdownuser">
                            <a id="btnstatus" class="@account_color" href="#">@DisplayName<i class="left material-icons ">person</i></a>
                        </li>
                    }
            </ul>
        </div>
    </nav>
</div>

<div id="dropdownuser" class="dropdown-content rounded-default row">
    <div class="center-align"><a class="grey-text" asp-area="Identity" asp-page="/Account/Manage/Index">Meu Perfil</a></></div>
    <div class="divider"></div>
    <div class="center-align"><div class="switch" title="Alterar meu status"><label style="font-size:10px;">OFF<input id="chkstatus" checked="@_status" type="checkbox" onclick="myStatus()" /><span class="lever"></span>ON</label></div></div>          
    <div class="divider"></div>
    <div><a asp-area="Identity" asp-page="/Account/Logout" class="grey-text">Sair<i class="left material-icons">logout</i></a></div>
</div>

<script>
    function myStatus() {
        var st = document.querySelector('#chkstatus');
        var uid = document.querySelector('#meustatusonline').value;
        const btnstatus = document.querySelector('#btnstatus');
        btnstatus.classList.remove('alpha-w-text-3');
        btnstatus.classList.remove('alpha-text-7');
        if (!st.checked) { $('#btnstatus').addClass('alpha-w-text-3'); }        
        else
        { $('#btnstatus').addClass('alpha-text-7'); }
        var formData = { id: uid, val: st.checked };
        $.get('/Identity/OnlineStatus', { id: uid, val : st.checked }, 
        function(returnedData){
        }).fail(function(){
            alert("Erro");
        });
    }
</script>

